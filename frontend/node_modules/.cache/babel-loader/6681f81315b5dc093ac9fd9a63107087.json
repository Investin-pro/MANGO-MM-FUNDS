{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst big_js_1 = __importDefault(require(\"big.js\"));\n\nconst bn_js_1 = __importDefault(require(\"bn.js\"));\n\nconst _1 = require(\".\");\n\nconst fixednum_1 = require(\"./utils/fixednum\");\n\nconst utils_1 = require(\"./utils/utils\");\n\nconst os_1 = require(\"os\");\n\nclass PerpMarket {\n  constructor(publicKey, baseDecimals, quoteDecimals, decoded) {\n    this.publicKey = publicKey;\n    this.baseDecimals = baseDecimals;\n    this.quoteDecimals = quoteDecimals;\n    Object.assign(this, decoded);\n    this.priceLotsToUiConvertor = new big_js_1.default(10).pow(baseDecimals - quoteDecimals).mul(new big_js_1.default(this.quoteLotSize.toString())).div(new big_js_1.default(this.baseLotSize.toString())).toNumber();\n    this.baseLotsToUiConvertor = new big_js_1.default(this.baseLotSize.toString()).div(new big_js_1.default(10).pow(baseDecimals)).toNumber();\n  }\n\n  priceLotsToNative(price) {\n    return fixednum_1.I80F48.fromI64(this.quoteLotSize.mul(price)).div(fixednum_1.I80F48.fromI64(this.baseLotSize));\n  }\n\n  baseLotsToNative(quantity) {\n    return fixednum_1.I80F48.fromI64(this.baseLotSize.mul(quantity));\n  }\n\n  priceLotsToNumber(price) {\n    return parseFloat(price.toString()) * this.priceLotsToUiConvertor;\n  }\n\n  baseLotsToNumber(quantity) {\n    return parseFloat(quantity.toString()) * this.baseLotsToUiConvertor;\n  }\n\n  get minOrderSize() {\n    if (this._minOrderSize === undefined) {\n      this._minOrderSize = this.baseLotsToNumber(_1.ONE_BN);\n    }\n\n    return this._minOrderSize;\n  }\n\n  get tickSize() {\n    if (this._tickSize === undefined) {\n      this._tickSize = this.priceLotsToNumber(_1.ONE_BN);\n    }\n\n    return this._tickSize;\n  }\n  /**\n   * Calculate the instantaneous funding rate using the bids and asks\n   * Reported as an hourly number\n   * Make sure `cache`, `bids` and `asks` are up to date\n   */\n\n\n  getCurrentFundingRate(group, cache, marketIndex, bids, asks) {\n    const IMPACT_QUANTITY = new bn_js_1.default(100);\n    const MIN_FUNDING = -0.05;\n    const MAX_FUNDING = 0.05;\n    const bid = bids.getImpactPriceUi(IMPACT_QUANTITY);\n    const ask = asks.getImpactPriceUi(IMPACT_QUANTITY);\n    const indexPrice = group.getPriceUi(marketIndex, cache);\n    let diff;\n\n    if (bid !== undefined && ask !== undefined) {\n      const bookPrice = (bid + ask) / 2;\n      diff = _1.clamp(bookPrice / indexPrice - 1, MIN_FUNDING, MAX_FUNDING);\n    } else if (bid !== undefined) {\n      diff = MAX_FUNDING;\n    } else if (ask !== undefined) {\n      diff = MIN_FUNDING;\n    } else {\n      diff = 0;\n    }\n\n    return diff / 24;\n  }\n\n  loadEventQueue(connection) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const acc = yield connection.getAccountInfo(this.eventQueue);\n\n      const parsed = _1.PerpEventQueueLayout.decode(acc === null || acc === void 0 ? void 0 : acc.data);\n\n      return new _1.PerpEventQueue(parsed);\n    });\n  }\n\n  loadFills(connection) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const q = yield this.loadEventQueue(connection); // TODO - verify this works\n\n      return q.eventsSince(utils_1.ZERO_BN).map(e => e.fill).filter(e => !!e).map(this.parseFillEvent.bind(this));\n    });\n  }\n\n  parseFillEvent(event) {\n    const quantity = this.baseLotsToNumber(event.quantity);\n    const price = this.priceLotsToNumber(event.price);\n    return Object.assign(Object.assign({}, event), {\n      quantity,\n      price\n    });\n  }\n\n  loadBids(connection) {\n    let includeExpired = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n    return __awaiter(this, void 0, void 0, function* () {\n      const acc = yield connection.getAccountInfo(this.bids);\n      return new _1.BookSide(this.bids, this, _1.BookSideLayout.decode(acc === null || acc === void 0 ? void 0 : acc.data), includeExpired);\n    });\n  }\n\n  loadAsks(connection) {\n    let includeExpired = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n    return __awaiter(this, void 0, void 0, function* () {\n      const acc = yield connection.getAccountInfo(this.asks);\n      return new _1.BookSide(this.asks, this, _1.BookSideLayout.decode(acc === null || acc === void 0 ? void 0 : acc.data), includeExpired);\n    });\n  }\n\n  loadOrdersForAccount(connection, account) {\n    let includeExpired = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n    return __awaiter(this, void 0, void 0, function* () {\n      const [bids, asks] = yield Promise.all([this.loadBids(connection, includeExpired), this.loadAsks(connection, includeExpired)]); // @ts-ignore\n\n      return [...bids, ...asks].filter(order => order.owner.equals(account.publicKey));\n    });\n  }\n\n  uiToNativePriceQuantity(price, quantity) {\n    const baseUnit = Math.pow(10, this.baseDecimals);\n    const quoteUnit = Math.pow(10, this.quoteDecimals);\n    const nativePrice = new bn_js_1.default(price * quoteUnit).mul(this.baseLotSize).div(this.quoteLotSize.mul(new bn_js_1.default(baseUnit)));\n    const nativeQuantity = new bn_js_1.default(quantity * baseUnit).div(this.baseLotSize);\n    return [nativePrice, nativeQuantity];\n  }\n\n  uiQuoteToLots(uiQuote) {\n    const quoteUnit = Math.pow(10, this.quoteDecimals);\n    return new bn_js_1.default(uiQuote * quoteUnit).div(this.quoteLotSize);\n  }\n\n  toPrettyString(group, perpMarketConfig) {\n    const info = group.perpMarkets[perpMarketConfig.marketIndex];\n    const oracle = group.oracles[perpMarketConfig.marketIndex];\n    const lmi = this.liquidityMiningInfo;\n    const now = Date.now() / 1000;\n    const start = lmi.periodStart.toNumber();\n    const elapsed = now - start;\n    const progress = 1 - lmi.mngoLeft.toNumber() / lmi.mngoPerPeriod.toNumber();\n    const est = start + elapsed / progress;\n    const lines = [`${perpMarketConfig.name}`, `version: ${this.metaData.version}`, `publicKey: ${perpMarketConfig.publicKey.toBase58()}`, `oracle: ${oracle.toBase58()}`, `initAssetWeight: ${group.perpMarkets[perpMarketConfig.marketIndex].initAssetWeight.toString()}`, `maintAssetWeight: ${group.perpMarkets[perpMarketConfig.marketIndex].maintAssetWeight.toString()}`, `marketIndex: ${perpMarketConfig.marketIndex}`, `bidsKey: ${this.bids.toBase58()}`, `asksKey: ${this.asks.toBase58()}`, `eventQueue: ${this.eventQueue.toBase58()}`, `quoteLotSize: ${this.quoteLotSize.toString()}`, `baseLotSize: ${this.baseLotSize.toString()}`, `longFunding: ${this.longFunding.toString()}`, `shortFunding: ${this.shortFunding.toString()}`, `openInterest: ${this.openInterest.toString()}`, `lastUpdated: ${new Date(this.lastUpdated.toNumber() * 1000).toUTCString()}`, `seqNum: ${this.seqNum.toString()}`, `liquidationFee: ${info.liquidationFee.toString()}`, `takerFee: ${info.takerFee.toString()}`, `makerFee: ${info.makerFee.toString()}`, `feesAccrued: ${_1.nativeToUi(this.feesAccrued.toNumber(), 6).toFixed(6)}`, `\\n----- ${perpMarketConfig.name} Liquidity Mining Info -----`, `rate: ${lmi.rate.toString()}`, `maxDepth: ${this.metaData.version === 0 ? lmi.maxDepthBps.toString() + ' bps' : lmi.maxDepthBps.toString() + ' contracts'}`, `exp: ${this.metaData.extraInfo[0] || 2}`, `lmSizeShift: ${this.metaData.extraInfo[1]}`, `periodStart: ${new Date(lmi.periodStart.toNumber() * 1000).toUTCString()}`, `targetPeriodLength: ${lmi.targetPeriodLength.toString()}`, `mngoLeftInPeriod: ${(lmi.mngoLeft.toNumber() / Math.pow(10, 6)).toFixed(2)}`, `mngoPerPeriod: ${(lmi.mngoPerPeriod.toNumber() / Math.pow(10, 6)).toFixed(2)}`, `periodProgress: ${progress * 100}%`, `estPeriodEnd: ${new Date(est * 1000).toUTCString()}`, `mngoVault: ${this.mngoVault.toString()}`];\n    return lines.join(os_1.EOL);\n  }\n\n}\n\nexports.default = PerpMarket;","map":{"version":3,"sources":["../../src/PerpMarket.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst big_js_1 = __importDefault(require(\"big.js\"));\nconst bn_js_1 = __importDefault(require(\"bn.js\"));\nconst _1 = require(\".\");\nconst fixednum_1 = require(\"./utils/fixednum\");\nconst utils_1 = require(\"./utils/utils\");\nconst os_1 = require(\"os\");\nclass PerpMarket {\n    constructor(publicKey, baseDecimals, quoteDecimals, decoded) {\n        this.publicKey = publicKey;\n        this.baseDecimals = baseDecimals;\n        this.quoteDecimals = quoteDecimals;\n        Object.assign(this, decoded);\n        this.priceLotsToUiConvertor = new big_js_1.default(10)\n            .pow(baseDecimals - quoteDecimals)\n            .mul(new big_js_1.default(this.quoteLotSize.toString()))\n            .div(new big_js_1.default(this.baseLotSize.toString()))\n            .toNumber();\n        this.baseLotsToUiConvertor = new big_js_1.default(this.baseLotSize.toString())\n            .div(new big_js_1.default(10).pow(baseDecimals))\n            .toNumber();\n    }\n    priceLotsToNative(price) {\n        return fixednum_1.I80F48.fromI64(this.quoteLotSize.mul(price)).div(fixednum_1.I80F48.fromI64(this.baseLotSize));\n    }\n    baseLotsToNative(quantity) {\n        return fixednum_1.I80F48.fromI64(this.baseLotSize.mul(quantity));\n    }\n    priceLotsToNumber(price) {\n        return parseFloat(price.toString()) * this.priceLotsToUiConvertor;\n    }\n    baseLotsToNumber(quantity) {\n        return parseFloat(quantity.toString()) * this.baseLotsToUiConvertor;\n    }\n    get minOrderSize() {\n        if (this._minOrderSize === undefined) {\n            this._minOrderSize = this.baseLotsToNumber(_1.ONE_BN);\n        }\n        return this._minOrderSize;\n    }\n    get tickSize() {\n        if (this._tickSize === undefined) {\n            this._tickSize = this.priceLotsToNumber(_1.ONE_BN);\n        }\n        return this._tickSize;\n    }\n    /**\n     * Calculate the instantaneous funding rate using the bids and asks\n     * Reported as an hourly number\n     * Make sure `cache`, `bids` and `asks` are up to date\n     */\n    getCurrentFundingRate(group, cache, marketIndex, bids, asks) {\n        const IMPACT_QUANTITY = new bn_js_1.default(100);\n        const MIN_FUNDING = -0.05;\n        const MAX_FUNDING = 0.05;\n        const bid = bids.getImpactPriceUi(IMPACT_QUANTITY);\n        const ask = asks.getImpactPriceUi(IMPACT_QUANTITY);\n        const indexPrice = group.getPriceUi(marketIndex, cache);\n        let diff;\n        if (bid !== undefined && ask !== undefined) {\n            const bookPrice = (bid + ask) / 2;\n            diff = _1.clamp(bookPrice / indexPrice - 1, MIN_FUNDING, MAX_FUNDING);\n        }\n        else if (bid !== undefined) {\n            diff = MAX_FUNDING;\n        }\n        else if (ask !== undefined) {\n            diff = MIN_FUNDING;\n        }\n        else {\n            diff = 0;\n        }\n        return diff / 24;\n    }\n    loadEventQueue(connection) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const acc = yield connection.getAccountInfo(this.eventQueue);\n            const parsed = _1.PerpEventQueueLayout.decode(acc === null || acc === void 0 ? void 0 : acc.data);\n            return new _1.PerpEventQueue(parsed);\n        });\n    }\n    loadFills(connection) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const q = yield this.loadEventQueue(connection);\n            // TODO - verify this works\n            return q\n                .eventsSince(utils_1.ZERO_BN)\n                .map((e) => e.fill)\n                .filter((e) => !!e)\n                .map(this.parseFillEvent.bind(this));\n        });\n    }\n    parseFillEvent(event) {\n        const quantity = this.baseLotsToNumber(event.quantity);\n        const price = this.priceLotsToNumber(event.price);\n        return Object.assign(Object.assign({}, event), { quantity,\n            price });\n    }\n    loadBids(connection, includeExpired = false) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const acc = yield connection.getAccountInfo(this.bids);\n            return new _1.BookSide(this.bids, this, _1.BookSideLayout.decode(acc === null || acc === void 0 ? void 0 : acc.data), includeExpired);\n        });\n    }\n    loadAsks(connection, includeExpired = false) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const acc = yield connection.getAccountInfo(this.asks);\n            return new _1.BookSide(this.asks, this, _1.BookSideLayout.decode(acc === null || acc === void 0 ? void 0 : acc.data), includeExpired);\n        });\n    }\n    loadOrdersForAccount(connection, account, includeExpired = false) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const [bids, asks] = yield Promise.all([\n                this.loadBids(connection, includeExpired),\n                this.loadAsks(connection, includeExpired),\n            ]);\n            // @ts-ignore\n            return [...bids, ...asks].filter((order) => order.owner.equals(account.publicKey));\n        });\n    }\n    uiToNativePriceQuantity(price, quantity) {\n        const baseUnit = Math.pow(10, this.baseDecimals);\n        const quoteUnit = Math.pow(10, this.quoteDecimals);\n        const nativePrice = new bn_js_1.default(price * quoteUnit)\n            .mul(this.baseLotSize)\n            .div(this.quoteLotSize.mul(new bn_js_1.default(baseUnit)));\n        const nativeQuantity = new bn_js_1.default(quantity * baseUnit).div(this.baseLotSize);\n        return [nativePrice, nativeQuantity];\n    }\n    uiQuoteToLots(uiQuote) {\n        const quoteUnit = Math.pow(10, this.quoteDecimals);\n        return new bn_js_1.default(uiQuote * quoteUnit).div(this.quoteLotSize);\n    }\n    toPrettyString(group, perpMarketConfig) {\n        const info = group.perpMarkets[perpMarketConfig.marketIndex];\n        const oracle = group.oracles[perpMarketConfig.marketIndex];\n        const lmi = this.liquidityMiningInfo;\n        const now = Date.now() / 1000;\n        const start = lmi.periodStart.toNumber();\n        const elapsed = now - start;\n        const progress = 1 - lmi.mngoLeft.toNumber() / lmi.mngoPerPeriod.toNumber();\n        const est = start + elapsed / progress;\n        const lines = [\n            `${perpMarketConfig.name}`,\n            `version: ${this.metaData.version}`,\n            `publicKey: ${perpMarketConfig.publicKey.toBase58()}`,\n            `oracle: ${oracle.toBase58()}`,\n            `initAssetWeight: ${group.perpMarkets[perpMarketConfig.marketIndex].initAssetWeight.toString()}`,\n            `maintAssetWeight: ${group.perpMarkets[perpMarketConfig.marketIndex].maintAssetWeight.toString()}`,\n            `marketIndex: ${perpMarketConfig.marketIndex}`,\n            `bidsKey: ${this.bids.toBase58()}`,\n            `asksKey: ${this.asks.toBase58()}`,\n            `eventQueue: ${this.eventQueue.toBase58()}`,\n            `quoteLotSize: ${this.quoteLotSize.toString()}`,\n            `baseLotSize: ${this.baseLotSize.toString()}`,\n            `longFunding: ${this.longFunding.toString()}`,\n            `shortFunding: ${this.shortFunding.toString()}`,\n            `openInterest: ${this.openInterest.toString()}`,\n            `lastUpdated: ${new Date(this.lastUpdated.toNumber() * 1000).toUTCString()}`,\n            `seqNum: ${this.seqNum.toString()}`,\n            `liquidationFee: ${info.liquidationFee.toString()}`,\n            `takerFee: ${info.takerFee.toString()}`,\n            `makerFee: ${info.makerFee.toString()}`,\n            `feesAccrued: ${_1.nativeToUi(this.feesAccrued.toNumber(), 6).toFixed(6)}`,\n            `\\n----- ${perpMarketConfig.name} Liquidity Mining Info -----`,\n            `rate: ${lmi.rate.toString()}`,\n            `maxDepth: ${this.metaData.version === 0\n                ? lmi.maxDepthBps.toString() + ' bps'\n                : lmi.maxDepthBps.toString() + ' contracts'}`,\n            `exp: ${this.metaData.extraInfo[0] || 2}`,\n            `lmSizeShift: ${this.metaData.extraInfo[1]}`,\n            `periodStart: ${new Date(lmi.periodStart.toNumber() * 1000).toUTCString()}`,\n            `targetPeriodLength: ${lmi.targetPeriodLength.toString()}`,\n            `mngoLeftInPeriod: ${(lmi.mngoLeft.toNumber() / Math.pow(10, 6)).toFixed(2)}`,\n            `mngoPerPeriod: ${(lmi.mngoPerPeriod.toNumber() / Math.pow(10, 6)).toFixed(2)}`,\n            `periodProgress: ${progress * 100}%`,\n            `estPeriodEnd: ${new Date(est * 1000).toUTCString()}`,\n            `mngoVault: ${this.mngoVault.toString()}`,\n        ];\n        return lines.join(os_1.EOL);\n    }\n}\nexports.default = PerpMarket;\n//# sourceMappingURL=PerpMarket.js.map"]},"metadata":{},"sourceType":"script"}