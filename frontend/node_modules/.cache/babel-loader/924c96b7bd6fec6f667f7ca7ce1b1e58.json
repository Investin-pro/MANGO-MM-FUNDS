{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst fixednum_1 = require(\"./utils/fixednum\");\n\nconst layout_1 = require(\"./layout\");\n\nconst utils_1 = require(\"./utils/utils\");\n\nclass RootBank {\n  //mintKey: PublicKey;\n  constructor(publicKey, decoded) {\n    this.publicKey = publicKey;\n    Object.assign(this, decoded);\n    this.nodeBankAccounts = []; //this.mintKey = tokenMint;\n  }\n\n  loadNodeBanks(connection) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const filteredNodeBanks = this.nodeBanks.filter(nb => !nb.equals(utils_1.zeroKey));\n      const accounts = yield utils_1.getMultipleAccounts(connection, filteredNodeBanks);\n      const nodeBankAccounts = accounts.map(acc => {\n        const decoded = layout_1.NodeBankLayout.decode(acc.accountInfo.data);\n        return new layout_1.NodeBank(acc.publicKey, decoded);\n      });\n      this.nodeBankAccounts = nodeBankAccounts;\n      return nodeBankAccounts;\n    });\n  }\n\n  getNativeTotalDeposit() {\n    if (!this.nodeBankAccounts.length) throw new Error('Node bank accounts empty');\n    let totalDeposits = fixednum_1.ZERO_I80F48;\n\n    for (let i = 0; i < this.nodeBankAccounts.length; i++) {\n      totalDeposits = totalDeposits.add(this.nodeBankAccounts[i].deposits);\n    }\n\n    return this.depositIndex.mul(totalDeposits);\n  }\n\n  getNativeTotalBorrow() {\n    if (!this.nodeBankAccounts.length) throw new Error('Node bank accounts empty');\n    let totalBorrow = fixednum_1.ZERO_I80F48;\n\n    for (let i = 0; i < this.nodeBankAccounts.length; i++) {\n      totalBorrow = totalBorrow.add(this.nodeBankAccounts[i].borrows);\n    }\n\n    return this.borrowIndex.mul(totalBorrow);\n  }\n\n  getUiTotalDeposit(mangoGroup) {\n    const tokenIndex = mangoGroup.getRootBankIndex(this.publicKey);\n    return utils_1.nativeI80F48ToUi(this.getNativeTotalDeposit(), mangoGroup.tokens[tokenIndex].decimals);\n  }\n\n  getUiTotalBorrow(mangoGroup) {\n    const tokenIndex = mangoGroup.getRootBankIndex(this.publicKey);\n    return utils_1.nativeI80F48ToUi(this.getNativeTotalBorrow(), mangoGroup.tokens[tokenIndex].decimals);\n  }\n\n  getBorrowRate(mangoGroup) {\n    const totalBorrows = this.getUiTotalBorrow(mangoGroup);\n    const totalDeposits = this.getUiTotalDeposit(mangoGroup);\n\n    if (totalDeposits.eq(fixednum_1.ZERO_I80F48) && totalBorrows.eq(fixednum_1.ZERO_I80F48)) {\n      return fixednum_1.ZERO_I80F48;\n    }\n\n    if (totalDeposits.lte(totalBorrows)) {\n      return this.maxRate;\n    }\n\n    const utilization = totalBorrows.div(totalDeposits);\n\n    if (utilization.gt(this.optimalUtil)) {\n      const extraUtil = utilization.sub(this.optimalUtil);\n      const slope = this.maxRate.sub(this.optimalRate).div(fixednum_1.I80F48.fromNumber(1).sub(this.optimalUtil));\n      return this.optimalRate.add(slope.mul(extraUtil));\n    } else {\n      const slope = this.optimalRate.div(this.optimalUtil);\n      return slope.mul(utilization);\n    }\n  }\n\n  getDepositRate(mangoGroup) {\n    const borrowRate = this.getBorrowRate(mangoGroup);\n    const totalBorrows = this.getUiTotalBorrow(mangoGroup);\n    const totalDeposits = this.getUiTotalDeposit(mangoGroup);\n\n    if (totalDeposits.eq(fixednum_1.ZERO_I80F48) && totalBorrows.eq(fixednum_1.ZERO_I80F48)) {\n      return fixednum_1.ZERO_I80F48;\n    } else if (totalDeposits.eq(fixednum_1.ZERO_I80F48)) {\n      return this.maxRate;\n    }\n\n    const utilization = totalBorrows.div(totalDeposits);\n    return utilization.mul(borrowRate);\n  }\n\n}\n\nexports.default = RootBank;","map":{"version":3,"sources":["../../src/RootBank.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst fixednum_1 = require(\"./utils/fixednum\");\nconst layout_1 = require(\"./layout\");\nconst utils_1 = require(\"./utils/utils\");\nclass RootBank {\n    //mintKey: PublicKey;\n    constructor(publicKey, decoded) {\n        this.publicKey = publicKey;\n        Object.assign(this, decoded);\n        this.nodeBankAccounts = [];\n        //this.mintKey = tokenMint;\n    }\n    loadNodeBanks(connection) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const filteredNodeBanks = this.nodeBanks.filter((nb) => !nb.equals(utils_1.zeroKey));\n            const accounts = yield utils_1.getMultipleAccounts(connection, filteredNodeBanks);\n            const nodeBankAccounts = accounts.map((acc) => {\n                const decoded = layout_1.NodeBankLayout.decode(acc.accountInfo.data);\n                return new layout_1.NodeBank(acc.publicKey, decoded);\n            });\n            this.nodeBankAccounts = nodeBankAccounts;\n            return nodeBankAccounts;\n        });\n    }\n    getNativeTotalDeposit() {\n        if (!this.nodeBankAccounts.length)\n            throw new Error('Node bank accounts empty');\n        let totalDeposits = fixednum_1.ZERO_I80F48;\n        for (let i = 0; i < this.nodeBankAccounts.length; i++) {\n            totalDeposits = totalDeposits.add(this.nodeBankAccounts[i].deposits);\n        }\n        return this.depositIndex.mul(totalDeposits);\n    }\n    getNativeTotalBorrow() {\n        if (!this.nodeBankAccounts.length)\n            throw new Error('Node bank accounts empty');\n        let totalBorrow = fixednum_1.ZERO_I80F48;\n        for (let i = 0; i < this.nodeBankAccounts.length; i++) {\n            totalBorrow = totalBorrow.add(this.nodeBankAccounts[i].borrows);\n        }\n        return this.borrowIndex.mul(totalBorrow);\n    }\n    getUiTotalDeposit(mangoGroup) {\n        const tokenIndex = mangoGroup.getRootBankIndex(this.publicKey);\n        return utils_1.nativeI80F48ToUi(this.getNativeTotalDeposit(), mangoGroup.tokens[tokenIndex].decimals);\n    }\n    getUiTotalBorrow(mangoGroup) {\n        const tokenIndex = mangoGroup.getRootBankIndex(this.publicKey);\n        return utils_1.nativeI80F48ToUi(this.getNativeTotalBorrow(), mangoGroup.tokens[tokenIndex].decimals);\n    }\n    getBorrowRate(mangoGroup) {\n        const totalBorrows = this.getUiTotalBorrow(mangoGroup);\n        const totalDeposits = this.getUiTotalDeposit(mangoGroup);\n        if (totalDeposits.eq(fixednum_1.ZERO_I80F48) && totalBorrows.eq(fixednum_1.ZERO_I80F48)) {\n            return fixednum_1.ZERO_I80F48;\n        }\n        if (totalDeposits.lte(totalBorrows)) {\n            return this.maxRate;\n        }\n        const utilization = totalBorrows.div(totalDeposits);\n        if (utilization.gt(this.optimalUtil)) {\n            const extraUtil = utilization.sub(this.optimalUtil);\n            const slope = this.maxRate\n                .sub(this.optimalRate)\n                .div(fixednum_1.I80F48.fromNumber(1).sub(this.optimalUtil));\n            return this.optimalRate.add(slope.mul(extraUtil));\n        }\n        else {\n            const slope = this.optimalRate.div(this.optimalUtil);\n            return slope.mul(utilization);\n        }\n    }\n    getDepositRate(mangoGroup) {\n        const borrowRate = this.getBorrowRate(mangoGroup);\n        const totalBorrows = this.getUiTotalBorrow(mangoGroup);\n        const totalDeposits = this.getUiTotalDeposit(mangoGroup);\n        if (totalDeposits.eq(fixednum_1.ZERO_I80F48) && totalBorrows.eq(fixednum_1.ZERO_I80F48)) {\n            return fixednum_1.ZERO_I80F48;\n        }\n        else if (totalDeposits.eq(fixednum_1.ZERO_I80F48)) {\n            return this.maxRate;\n        }\n        const utilization = totalBorrows.div(totalDeposits);\n        return utilization.mul(borrowRate);\n    }\n}\nexports.default = RootBank;\n//# sourceMappingURL=RootBank.js.map"]},"metadata":{},"sourceType":"script"}